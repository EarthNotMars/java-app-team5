#!/usr/bin/env groovy
properties([disableConcurrentBuilds()])

pipeline {
  agent {
    label 'ubuntu'
  }
  options {
    timestamps()
  }
  stages {
    stage('Check terraform') {
      steps {
        sh "terraform --version"
      }
    }
    stage('Az login'){
      steps {
        script {
          withCredentials([azureServicePrincipal("${AZURE_CREDENTIALS}")]) {
            sh "az login --service-principal -u '${AZURE_CLIENT_ID}' -p '${AZURE_CLIENT_SECRET}' -t '${AZURE_TENANT_ID}'"
          }
        }
      }
    }
    stage('Terraform init') {
      steps {
        sh "terraform init"
      }
    }
    stage('Terraform apply') {
      steps {
        sh "echo Test"
      }
    }
  }
}