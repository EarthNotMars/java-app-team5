#!/usr/bin/env groovy
properties([disableConcurrentBuilds()])

TARGET_BRANCH_NAME = "monitor"

pipeline {
  agent {
    label 'ubuntu'
  }

  options {
    timestamps()
  }


  stages {
    stage('Prepare terraform') {
      steps {
        sh "git checkout '${TARGET_BRANCH_NAME}'"
        deleteDir() // Clean up the workspace
        checkout scm
        withCredentials([string(credentialsId: 'email-dev1', variable: 'email1')]) {
          sh "echo $email1"
        }
        withCredentials([file(credentialsId: 'vm_variables', variable: 'monit_variables')]) {
          sh "sudo cp $monit_variables ./monitor/variables.tf"
          sh "sudo chmod 664 ./monitor/variables.tf"
        }
      }
    }

    stage('Run monitor') {
      steps {
        sh """
          cd ./monitor/
          sudo terraform init --get=true
          sudo terraform plan -out=monitor.out -no-color
          sudo terraform apply -no-color monitor.out
        """
      }
    }
  }
}